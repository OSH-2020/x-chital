<!doctype html><html><head><meta charset=UTF-8><title>结题报告 - By dnailz</title><link rel=stylesheet href=//cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=//cdn.staticfile.org/prism/1.15.0/themes/prism.min.css><link rel=stylesheet href=//cdn.staticfile.org/KaTeX/0.10.0-rc.1/katex.min.css><link href=./css/chunk-vendors.4e4765ff.css rel=stylesheet></head><body><div><article id=webslides><section slide class="slide bg-black-blue aligncenter" image="https://source.unsplash.com/C1HhAQrbykQ/ .dark"><span class="background dark" style="background-image:url('https://source.unsplash.com/C1HhAQrbykQ/')"></span><div class=wrap wrap=true><h1 class="text-landing text-shadow">结题报告</h1><p class=text-intro>By x-chital</p><p><a href=https://github.com/OSH-2020/x-chital class="button ghost" target=_blank><i class="fa fa-github"></i> Github</a></p></div></section><section slide class=slide :class=size-80><div class="wrap size-80" wrap=true><h3>搭建 Rust + Linux 内核模块开发环境</h3><hr><ul><li class="animated fadeInUp">借助 fjw 助教提供的 VLab KVM 虚拟机远程共同开发。</li><li class="animated fadeInUp delay-400">使用 Github 项目 <a href=https://github.com/fishinabarrel/linux-kernel-module-rust target=_blank>linux-kernel-module-rust</a> 进行 LKM + Rust 开发</li><li class="animated fadeInUp delay-800">借助 RLS（Rust Language Server）搭建开发环境</li></ul></div></section><section slide class=slide :class=size-80><div class="wrap size-80" wrap=true><div class="vertical-align grid"><div class=column><h3>系统调用替换的实现</h3><h1></h1><h1></h1><h1></h1><h1></h1><p>使用 <code>kallsyms_lookup_name</code> 得到系统调用表后，编写一个简单的 C-Shim, 实现对系统调用的替换。</p><p>由于 Linux 的内存保护机制，需要暂时禁止掉内存的写保护。</p></div><div class=column><pre class=language-c><code class=language-c><span class="token keyword">int</span> <span class="token function">replace_syscall</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> syscall_num<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>syscall_fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    cr0 <span class="token operator">=</span> <span class="token function">disable_wp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭内存写保护</span>
    syscall_table<span class="token punctuation">[</span>syscall_num<span class="token punctuation">]</span> <span class="token operator">=</span> syscall_fn<span class="token punctuation">;</span> <span class="token comment">// 替换相应的系统调用</span>
    <span class="token function">restore_wp</span><span class="token punctuation">(</span>cr0<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 恢复内存写保护</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div></section><section slide class=slide :class=size-80><div class="wrap size-80" wrap=true><div class="vertical-align grid"><div class=column><h3>实现内核与用户的交互</h3><h1></h1><h1></h1><h1></h1><h1></h1><p>实现内核与用户的交互的其他方式：系统调用方式（<code>seccomp</code>）、文件系统方式（<code>cgroup</code>）</p><p>在系统中添加一个虚拟设备节点类型 <code>rvisor</code>，使用 <code>mknod</code> 创建节点后，可以通过 <code>ioctl</code> 系统调用进行交互。</p><p>命令列表如下</p><blockquote><ul><li><code>create</code> 新建一个容器环境</li><li><code>addproc</code> 增加一个进程</li><li><code>remove</code> 删除一个进程</li></ul></blockquote></div><div class=column><pre class=language-rust><code class=language-rust>    <span class="token comment">/// 对用户空间的iotcl调用做出反应</span>
    <span class="token comment">/// * create 命令新建一个容器环境</span>
    <span class="token comment">/// * addproc 增加一个进程</span>
    <span class="token comment">/// * remove 删除一个进程</span>
    <span class="token keyword">fn</span> <span class="token function">ioctl</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> cmd<span class="token punctuation">:</span>u32<span class="token punctuation">,</span> arg<span class="token punctuation">:</span> u64<span class="token punctuation">)</span> <span class="token punctuation">-></span> KernelResult<span class="token operator">&lt;</span>i64<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">info!</span><span class="token punctuation">(</span><span class="token string">"ioctl cmd={} arg={}"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> container <span class="token operator">=</span> Container<span class="token punctuation">::</span><span class="token function">get_container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> cmd <span class="token operator">=</span> IoctlCmd<span class="token punctuation">::</span><span class="token function">try_from</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> cmd <span class="token punctuation">{</span>
            IoctlCmd<span class="token punctuation">::</span>Create <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> path_str <span class="token operator">=</span> string<span class="token punctuation">::</span><span class="token function">read_from_user</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> kernel<span class="token punctuation">::</span>PATH_MAX<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
                container<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>path_str<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
                <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            IoctlCmd<span class="token punctuation">::</span>AddProc <span class="token operator">=></span> <span class="token punctuation">{</span>
                container<span class="token punctuation">.</span><span class="token function">add_task</span><span class="token punctuation">(</span>arg <span class="token keyword">as</span> i32<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
                <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            IoctlCmd<span class="token punctuation">::</span>Remove <span class="token operator">=></span> <span class="token punctuation">{</span>
                container<span class="token punctuation">.</span><span class="token function">remove_task</span><span class="token punctuation">(</span>arg <span class="token keyword">as</span> i32<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
                <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div></div></div></section><section slide class=slide :class=size-80><div class="wrap size-80" wrap=true><h3>在 Rust 中实现内核同步</h3><hr><ul><li>原子操作：rust 的引用计数智能指针 <code>Arc</code> 提供的相关操作是原子的，故可以直接使用。</li><li>自旋锁、自旋读写锁： rust no_std 本身没有提供，但是可以通过外部库来实现（这个库本身使用不到任何内核模块相关的东西，可以放心使用）。</li><li>Rcu 锁：这个使用内核的 Rcu 锁，并封装成一个 Rust 的 struct 为 <code>RcuLock</code>。</li></ul></div></section><section slide class=slide :class=size-80><div class="wrap size-80" wrap=true><h3>模拟 Linux 虚拟文件系统</h3><h1></h1><h1></h1><h1></h1><h1></h1><h1></h1><h1></h1><h1></h1><h1></h1><div class="vertical-align grid"><div class=column><pre class=language-c><code class=language-c>
<span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token punctuation">{</span>         
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>           i_ino<span class="token punctuation">;</span>
        atomic_t                i_count<span class="token punctuation">;</span>
        umode_t                 i_mode<span class="token punctuation">;</span>
        uid_t                   i_uid<span class="token punctuation">;</span>
        gid_t                   i_gid<span class="token punctuation">;</span>
        kdev_t                  i_rdev<span class="token punctuation">;</span>
        loff_t                  i_size<span class="token punctuation">;</span>
        spinlock_t              i_lock<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">file_operations</span>  <span class="token operator">*</span>i_fop<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token punctuation">{</span>
        atomic_t                 d_count<span class="token punctuation">;</span>      
        spinlock_t               d_lock<span class="token punctuation">;</span>       
        <span class="token keyword">struct</span> <span class="token class-name">inode</span>             <span class="token operator">*</span>d_inode<span class="token punctuation">;</span>     
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>         d_child<span class="token punctuation">;</span>      
        <span class="token keyword">struct</span> <span class="token class-name">dentry_operations</span> <span class="token operator">*</span>d_op<span class="token punctuation">;</span>        
        <span class="token keyword">struct</span> <span class="token class-name">rcu_head</span>          d_rcu<span class="token punctuation">;</span>        
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class=column><pre class=language-rust><code class=language-rust><span class="token attribute attr-name">#[derive(Debug, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> INode <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> ino <span class="token punctuation">:</span> u64<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> mode <span class="token punctuation">:</span> u64<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> uid <span class="token punctuation">:</span> u64<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> gid <span class="token punctuation">:</span> u64<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Debug, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> DEntry <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> name <span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> inode <span class="token punctuation">:</span> INode<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> parent <span class="token punctuation">:</span> Weak<span class="token operator">&lt;</span>RcuLock<span class="token operator">&lt;</span>DEntry<span class="token operator">>></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> child <span class="token punctuation">:</span> LinkedList<span class="token operator">&lt;</span>Arc<span class="token operator">&lt;</span>RcuLock<span class="token operator">&lt;</span>DEntry<span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> fops <span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>Rc<span class="token operator">&lt;</span><span class="token keyword">dyn</span> FileOperations<span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div></section><section slide class=slide :class=size-80><div class="wrap size-80" wrap=true><h3>文件系统的读写</h3><p>未完成，计划本周完成。</p></div></section><section slide class=slide :class=size-80><div class="wrap size-80" wrap=true><h3>进程管理系统</h3><p>未完成</p></div></section><section slide class=slide :class=size-80><div class="wrap size-80" wrap=true><h3>proc 文件系统</h3><p>基于之前编写的虚拟文件系统，实现一个 proc 文件系统。增加对 <code>top</code> 指令的支持。可以查看当前真是的内核信息。</p></div></section></article></div><script src=//cdn.staticfile.org/echarts/4.1.0-release/echarts.min.js></script><script>window.pluginsOptions = {}



document.addEventListener('DOMContentLoaded', () => {
    let isPrintMode = false;
    if(~location.search.indexOf('print-pdf')){
        isPrintMode = true;
        WebSlides.registerPlugin('scroll', function(){});
    }
    const ws = new WebSlides({
        loop: false
    })
    window.wsInstance = ws;
    if(isPrintMode){
        ws.slides.forEach(s=>s.show())
    }
}, false)</script><script src=./js/chunk-vendors.js></script><script src=./js/final.js></script></body></html>